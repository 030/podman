# podman

## installation

<https://podman.io/docs/installation/>

```bash
curl -L https://github.com/containers/podman/releases/download/v5.3.1/podman-remote-static-linux_amd64.tar.gz -o /tmp/podman.tar.gz && \
tar -xvf /tmp/podman.tar.gz -C /tmp
sudo mv /tmp/bin/podman-remote-static-linux_amd64 /usr/local/bin/podman
podman --version
```

## configuration

```bash
sudo apt remove qemu-system
```

```bash
podman machine rm --force
```

```bash
podman machine init
```

```bash
curl -L https://github.com/containers/gvisor-tap-vsock/releases/download/v0.8.1/gvproxy-linux-amd64 -o /tmp/gvproxy && \
sudo mv /tmp/gvproxy /usr/libexec/podman/
chmod +x /usr/libexec/podman/gvproxy
/usr/libexec/podman/gvproxy --version
```

```bash
curl -L https://gitlab.com/virtio-fs/virtiofsd/-/jobs/8484776667/artifacts/download?file_type=archive -o /tmp/virtiofsd.zip
unzip /tmp/virtiofsd.zip
./target/x86_64-unknown-linux-musl/release/virtiofsd --version
sudo mv ./target/x86_64-unknown-linux-musl/release/virtiofsd  /usr/libexec/podman/
```

```bash
podman machine --log-level=debug start
```

sgdfdgfaddf

```bash
qemu-system-x86_64 --version
```

```bash
cd /tmp
git clone https://gitlab.com/qemu-project/qemu.git
cd qemu
git checkout v9.2.0
```

https://wiki.qemu.org/Hosts/Linux

```bash
sudo apt-get install git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev ninja-build
```

Other packages that are required as well (turned out after running make):

```bash
sudo apt install flex bison
```

```bash
mkdir build && \
cd build && \
../configure && \
make -j$(nproc)
```

```bash
sudo make install
```

```bash
qemu-system-x86_64 --version
```

should return: v9.2.0

```bash
podman machine ls
```

podman machine start stuck “Waiting for VM” indefinitely with qemu synchronous
exception on macOS M1 (#20776).

downgrading to 8.2.1

git checkout v8.2.1

## commands

Same commands as docker.

```bash
podman run \
  --detach \
  --tty \
  --publish 8080:80/tcp docker.io/library/httpd
```

```bash
podman logs --follow c5cd0b1cc1a2
```

```bash
podman top c5cd0b1cc1a
```

```bash
podman stop --all
```

```bash
podman rm --all
```

## build

```bash
podman build --build --platform linux/amd64,linux/arm64 -t my-image .
```

https://www.redhat.com/en/blog/podman-edge-healthcheck

```bash
podman run \
  --name awesome_booth \
  --detach \
  --tty \
  --publish 8080:3000/tcp \
  --health-on-failure=kill \
  --health-retries=1 \
  my-image
```

https://github.com/docker-library/httpd/tree/500ef8b71bdf49020ec5bffad2b100936c3f2fab/2.4/alpine

https://raw.githubusercontent.com/docker-library/httpd/500ef8b71bdf49020ec5bffad2b100936c3f2fab/2.4/alpine/httpd-foreground

###### todo

podman run --name my-container \
 --health-cmd="curl -f http://localhost/ || exit 1" \
 --health-interval=30s \
 --health-timeout=5s \
 --health-retries=3 \
 your-image

sudo vim /etc/systemd/system/awesome_booth.service

sudo systemctl daemon-reload
sudo systemctl enable awesome_booth
sudo systemctl start my-container

note: /usr/local/bin/podman

###############################
########################
######################

```bash
podman run \
  --log-level=debug \
  --detach \
  --name bladibla \
  --publish 8080:3000/tcp \
  --rm \
  --cidfile=/tmp/my-container.cid \
  my-image
```

```bash
podman generate systemd \
  --new \
  --name bladibla
```

sudo vim /etc/systemd/system/bladibla.service

```bash
# container-bladibla.service
# autogenerated by Podman 5.3.1
# Sun Dec 22 10:44:46 CET 2024

[Unit]
Description=Podman container-bladibla.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman run \
        --cidfile=%t/%n.ctr-id \
        --cgroups=no-conmon \
        --rm \
        --sdnotify=conmon \
        --replace \
        --detach \
        --name bladibla \
        --publish 8080:3000/tcp \
        --health-cmd="/healthcheck.sh" \
        --health-interval=30s \
        --health-timeout=15s \
        --health-retries=3 \
          my-image
# ExecStop=/usr/bin/podman stop \
#         --ignore -t 10 \
#         --cidfile=%t/%n.ctr-id
# ExecStopPost=/usr/bin/podman rm \
#         -f \
#         --ignore -t 10 \
#         --cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target
```

```bash
systemctl list-unit-files | grep blad
```

```bash
sudo systemctl enable bladibla
sudo systemctl start bladibla
```

## troubleshooting

journalctl -u bladibla.service -b

#########################
#########################
#########################

mkdir -p ~/.config/systemd/user
vim ~/.config/systemd/user/bladibla.service

```bash
# container-bladibla.service
# autogenerated by Podman 5.3.1
# Sun Dec 22 10:44:46 CET 2024

[Unit]
Description=Podman container-bladibla.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
#RequiresMountsFor=${XDG_RUNTIME_DIR}/containers

[Service]
# Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
RestartSec=30s
TimeoutStopSec=70
#ExecStartPre=/bin/rm -f ${XDG_RUNTIME_DIR}/%n.pid ${XDG_RUNTIME_DIR}/%n.ctr-id
ExecStart=/usr/bin/podman run \
        --rm \
        --replace \
        --name bladibla \
        --publish 8080:3000/tcp \
        --health-cmd="/healthcheck.sh" \
        --health-interval=30s \
        --health-timeout=15s \
        --health-retries=3 \
        --health-start-period=10s \
        --health-startup-cmd="/healthcheck.sh" \
        --health-startup-interval=10s \
        --health-startup-retries=3 \
          my-image
ExecStop=/usr/bin/podman stop \
          --log-level=debug \
          bladibla
         #--ignore -t 10 \
         #--cidfile=${XDG_RUNTIME_DIR}/%n.ctr-id
# ExecStopPost=/usr/bin/podman rm \
#         --log-level=debug \
#         -f \
#         --ignore -t 10 \
#         --cidfile=${XDG_RUNTIME_DIR}/%n.ctr-id
#PIDFile=${XDG_RUNTIME_DIR}/%n.pid
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target
```

```bash
systemctl --user enable bladibla
systemctl --user start bladibla
```

journalctl --user -u bladibla.service

systemctl --user cat bladibla.service

echo $XDG_RUNTIME_DIR
/run/user/1000

systemctl --user daemon-reload

```
# container-bladibla.service
# autogenerated by Podman 5.3.1
# Sun Dec 22 10:44:46 CET 2024

[Unit]
Description=Podman container-bladibla.service
After=network-online.target

[Service]
Restart=on-failure
RestartSec=5s
ExecStart=/usr/bin/podman run \
        --rm \
        --replace \
        --name bladibla \
        --publish 8080:3000/tcp \
        --health-cmd="/healthcheck.sh" \
        --health-interval=30s \
        --health-timeout=15s \
        --health-retries=3 \
        --health-start-period=10s \
        --health-startup-cmd="/healthcheck.sh" \
        --health-startup-interval=10s \
        --health-startup-retries=3 \
          my-image
ExecStop=/usr/bin/podman stop \
          --log-level=debug \
          bladibla

[Install]
WantedBy=multi-user.target
```

https://medium.com/@javier-canizalez/leveraging-the-power-of-systemd-in-podman-containers-1b224a01664b
https://www.fosslinux.com/50383/how-to-run-and-manage-containers-as-systemd-services-with-podman.htm
https://www.redhat.com/en/blog/container-systemd-persist-reboot
https://www.redhat.com/en/blog/quadlet-podman
https://linuxhandbook.com/autostart-podman-containers/
Run podman with: –log-level=debug
https://www.tutorialworks.com/podman-systemd/
https://docs.aws.amazon.com/greengrass/v2/developerguide/what-is-iot-greengrass.html
https://medium.com/@d.sithunaash/monitoring-multiple-raspberry-pis-with-grafana-influxdb-and-telegraf-7e83365057b8
https://medium.com/@tech_18484/unveiling-the-power-trio-telegraf-influxdb-grafana-for-seamless-ubuntu-monitoring-305094d19e0e
Hardware spec:
Disk, emc where os installed, sd or not? Log rotation, max removal? Broken aftwr 1000 wtites
https://www.redhat.com/en/blog/container-systemd-persist-reboot
